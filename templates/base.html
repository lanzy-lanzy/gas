<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Prycegas Station{% endblock %}</title>

    <!-- TailwindCSS CDN with custom configuration -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'prycegas-black': '#1a1a1a',
                        'prycegas-orange': '#ff6b35',
                        'prycegas-orange-light': '#ff8c5a',
                        'prycegas-orange-dark': '#e55a2b',
                        'prycegas-gray': '#2d2d2d',
                        'prycegas-gray-light': '#404040',
                    }
                }
            }
        }
    </script>

    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <!-- Three.js for 3D animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    {% load static humanize %}

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/custom.css' %}">

    <!-- Custom styles -->
    <style>
        /* Custom scrollbar for sidebar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #2d2d2d;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #ff6b35;
            border-radius: 2px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #ff8c5a;
        }

        /* Performance optimizations for slow connections */
        .slow-connection * {
            animation-duration: 0.01ms !important;
            animation-delay: 0.01ms !important;
            transition-duration: 0.01ms !important;
            transition-delay: 0.01ms !important;
        }

        /* Lazy loading images */
        img.lazy {
            opacity: 0;
            transition: opacity 0.3s;
        }

        img.lazy.loaded {
            opacity: 1;
        }

        /* Touch optimization for mobile */
        .touch-optimized {
            min-height: 44px;
            min-width: 44px;
        }

        /* Offline indicator */
        .offline::before {
            content: "You are offline";
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #ef4444;
            color: white;
            text-align: center;
            padding: 8px;
            z-index: 9999;
            font-size: 14px;
        }

        /* Pull to refresh indicator */
        #pull-refresh-indicator {
            position: fixed;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        /* Loading states */
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* Scroll indicator */
        .scroll-indicator {
            position: fixed;
            top: 0;
            left: 0;
            height: 3px;
            background: #ff6b35;
            z-index: 9999;
            transition: width 0.1s ease;
        }

        /* 3D Animation Canvas */
        #sidebar-3d-canvas {
            display: block;
            width: 100%;
            height: 150px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border-bottom: 1px solid #404040;
            touch-action: none;
        }

        .sidebar-3d-container {
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        }

        /* Floating animation for elements in 3D scene */
        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-20px);
            }
        }

        .floating-element {
            animation: float 6s ease-in-out infinite;
        }
    </style>

    {% block extra_head %}{% endblock %}
</head>

<body class="h-full bg-gray-50" x-data="{ sidebarOpen: false }">
    <div class="flex h-full">
        <!-- Mobile sidebar overlay -->
        <div x-show="sidebarOpen" x-transition:enter="transition-opacity ease-linear duration-300"
            x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
            x-transition:leave="transition-opacity ease-linear duration-300" x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0" class="fixed inset-0 z-40 lg:hidden" @click="sidebarOpen = false">
            <div class="fixed inset-0 bg-gray-900 bg-opacity-75"></div>
        </div>

        <!-- Sidebar -->
        <div class="hidden lg:flex lg:flex-shrink-0">
            <div class="flex flex-col w-64 bg-prycegas-black">
                {% include 'components/sidebar.html' %}
            </div>
        </div>

        <!-- Mobile sidebar -->
        <div x-show="sidebarOpen" x-transition:enter="transition ease-in-out duration-300 transform"
            x-transition:enter-start="-translate-x-full" x-transition:enter-end="translate-x-0"
            x-transition:leave="transition ease-in-out duration-300 transform" x-transition:leave-start="translate-x-0"
            x-transition:leave-end="-translate-x-full"
            class="fixed inset-y-0 left-0 z-50 w-64 bg-prycegas-black lg:hidden">
            {% include 'components/sidebar.html' %}
        </div>

        <!-- Main content area -->
        <div class="flex flex-col flex-1 overflow-hidden">
            <!-- Top navigation bar for mobile -->
            <div class="lg:hidden bg-white shadow-sm border-b border-gray-200">
                <div class="flex items-center justify-between px-4 py-3">
                    <button @click="sidebarOpen = !sidebarOpen"
                        class="text-gray-500 hover:text-gray-600 focus:outline-none focus:text-gray-600 transition-colors">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-prycegas-orange rounded-lg flex items-center justify-center mr-2">
                            <img src="{% static 'images/gas.png' %}" alt="LPG Tank"
                                class="w-full h-full object-contain">
                        </div>
                        <h1 class="text-lg font-semibold text-gray-900">Prycegas Station</h1>
                    </div>
                    <div class="flex items-center space-x-3">
                        {% if user.is_authenticated and not user.is_staff and not user.cashier_profile %}
                        <a href="{% url 'core:profile' %}" class="flex-shrink-0">
                            {% if user.customer_profile.profile_picture %}
                            <img src="{{ user.customer_profile.profile_picture.url }}" alt="Profile"
                                class="h-8 w-8 rounded-lg object-cover border border-prycegas-orange border-opacity-30">
                            {% else %}
                            <div
                                class="h-8 w-8 bg-prycegas-orange bg-opacity-10 text-prycegas-orange rounded-lg flex items-center justify-center border border-prycegas-orange border-opacity-20">
                                <span class="text-xs font-bold">{{
                                    user.first_name|first|default:user.username|first|upper }}</span>
                            </div>
                            {% endif %}
                        </a>
                        <a href="{% url 'core:customer_notifications' %}"
                            class="relative p-1 text-gray-500 hover:text-prycegas-orange transition-colors">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                            </svg>
                            {% if unread_notification_count > 0 %}
                            <span
                                class="absolute top-0 right-0 block h-2.5 w-2.5 rounded-full ring-2 ring-white bg-red-500"></span>
                            {% endif %}
                        </a>
                        {% else %}
                        <div class="w-6"></div> <!-- Spacer for centering -->
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Main content -->
            <main class="flex-1 overflow-y-auto focus:outline-none bg-gray-50">
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>

    <!-- Pull to refresh indicator -->
    <div id="pull-refresh-indicator">
        <svg class="h-5 w-5 text-prycegas-orange animate-spin" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg>
    </div>

    <!-- Scroll progress indicator -->
    <div class="scroll-indicator" style="width: 0%"></div>

    <!-- Toast notifications container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2" x-data="{ toasts: [] }"
        @toast.window="toasts.push($event.detail); setTimeout(() => toasts.shift(), 5000)">
        <template x-for="toast in toasts" :key="toast.id">
            <div x-show="true" x-transition:enter="transform ease-out duration-300 transition"
                x-transition:enter-start="translate-y-2 opacity-0 sm:translate-y-0 sm:translate-x-2"
                x-transition:enter-end="translate-y-0 opacity-100 sm:translate-x-0"
                x-transition:leave="transition ease-in duration-100" x-transition:leave-start="opacity-100"
                x-transition:leave-end="opacity-0"
                class="max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden">
                <div class="p-4">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <svg x-show="toast.type === 'success'" class="h-6 w-6 text-green-400" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <svg x-show="toast.type === 'error'" class="h-6 w-6 text-red-400" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <svg x-show="toast.type === 'info'" class="h-6 w-6 text-blue-400" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                        </div>
                        <div class="ml-3 w-0 flex-1 pt-0.5">
                            <p class="text-sm font-medium text-gray-900" x-text="toast.title"></p>
                            <p class="mt-1 text-sm text-gray-500" x-text="toast.message"></p>
                        </div>
                        <div class="ml-4 flex-shrink-0 flex">
                            <button @click="toasts.splice(toasts.indexOf(toast), 1)"
                                class="bg-white rounded-md inline-flex text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-prycegas-orange">
                                <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- CSRF Token for HTMX -->
    {% csrf_token %}
    <meta name="csrf-token" content="{{ csrf_token }}">

    <!-- Utility JavaScript -->
    <script src="{% static 'js/utils.js' %}"></script>

    <!-- Flatpickr -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- HTMX CSRF Configuration -->
    <script>
        // Configure HTMX to include CSRF token in requests
        document.addEventListener('htmx:configRequest', function (evt) {
            const token = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
            if (token) {
                evt.detail.headers['X-CSRFToken'] = token;
            }
        });

        // Ensure Alpine.js components are reinitialized after HTMX swaps
        document.addEventListener('htmx:afterSwap', function (evt) {
            const alpineElements = evt.detail.target.querySelectorAll('[x-data]');
            if (alpineElements.length > 0 && typeof Alpine !== 'undefined') {
                console.log('Reinitializing Alpine.js components after HTMX swap');
                alpineElements.forEach(el => {
                    if (!el._x_dataStack) {
                        Alpine.initTree(el);
                    }
                });
            }
        });
    </script>

    <!-- 3D Sidebar Animation Script -->
    <script>
        // Initialize Three.js scene for sidebar animation
        function initSidebar3D() {
            const canvas = document.getElementById('sidebar-3d-canvas');
            if (!canvas) return;

            // Scene setup
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });

            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            renderer.setClearColor(0x000000, 0);
            renderer.setPixelRatio(window.devicePixelRatio);

            camera.position.z = 3;

            // Create floating geometric shapes
            const shapes = [];
            const colors = [0xff6b35, 0xff8c5a, 0xe55a2b]; // Prycegas orange shades

            // Create rotating cubes
            for (let i = 0; i < 3; i++) {
                const geometry = new THREE.BoxGeometry(0.4, 0.4, 0.4);
                const material = new THREE.MeshPhongMaterial({
                    color: colors[i],
                    wireframe: false,
                    emissive: colors[i],
                    emissiveIntensity: 0.3
                });
                const cube = new THREE.Mesh(geometry, material);
                cube.position.x = (i - 1) * 1.2;
                cube.rotation.x = Math.random() * Math.PI;
                cube.rotation.y = Math.random() * Math.PI;
                cube.userData = {
                    rotationSpeedX: (Math.random() - 0.5) * 0.02,
                    rotationSpeedY: (Math.random() - 0.5) * 0.02,
                    rotationSpeedZ: (Math.random() - 0.5) * 0.02,
                    originalY: cube.position.y
                };
                scene.add(cube);
                shapes.push(cube);
            }

            // Create particles
            const particleGeometry = new THREE.BufferGeometry();
            const particleCount = 50;
            const positions = new Float32Array(particleCount * 3);

            for (let i = 0; i < particleCount * 3; i += 3) {
                positions[i] = (Math.random() - 0.5) * 6;
                positions[i + 1] = (Math.random() - 0.5) * 4;
                positions[i + 2] = (Math.random() - 0.5) * 4;
            }

            particleGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            const particleMaterial = new THREE.PointsMaterial({
                color: 0xff6b35,
                size: 0.05,
                sizeAttenuation: true,
                transparent: true,
                opacity: 0.6
            });
            const particles = new THREE.Points(particleGeometry, particleMaterial);
            scene.add(particles);

            // Lighting
            const light1 = new THREE.PointLight(0xff6b35, 1);
            light1.position.set(5, 5, 5);
            scene.add(light1);

            const light2 = new THREE.PointLight(0xff8c5a, 0.8);
            light2.position.set(-5, -5, 5);
            scene.add(light2);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);

            // Handle window resize
            function onWindowResize() {
                const width = canvas.clientWidth;
                const height = canvas.clientHeight;
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            }
            window.addEventListener('resize', onWindowResize);

            // Animation loop
            function animate() {
                requestAnimationFrame(animate);

                // Rotate cubes
                shapes.forEach((shape, index) => {
                    shape.rotation.x += shape.userData.rotationSpeedX;
                    shape.rotation.y += shape.userData.rotationSpeedY;
                    shape.rotation.z += shape.userData.rotationSpeedZ;

                    // Floating animation
                    shape.position.y = shape.userData.originalY + Math.sin(Date.now() * 0.001 + index) * 0.5;
                });

                // Rotate particles
                particles.rotation.x += 0.0002;
                particles.rotation.y += 0.0003;

                renderer.render(scene, camera);
            }

            animate();
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', initSidebar3D);

        // Reinitialize on HTMX swap if sidebar is updated
        document.addEventListener('htmx:afterSwap', function (evt) {
            if (evt.detail.target.closest('.sidebar-3d-container, #sidebar-3d-canvas')) {
                // Small delay to ensure DOM is ready
                setTimeout(initSidebar3D, 100);
            }
        });
    </script>

    {% block extra_js %}{% endblock %}
</body>

</html>