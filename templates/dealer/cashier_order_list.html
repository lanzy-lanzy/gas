{% extends 'base.html' %}
{% load humanize %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-4xl font-bold text-gray-900 mb-2">
            <i class="fas fa-list text-prycegas-orange mr-3"></i>Process Customer Orders
        </h1>
        <p class="text-gray-600">View and process all customer orders</p>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-prycegas-orange">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Total Orders</p>
                    <p class="text-3xl font-bold text-gray-900">{{ summary_stats.total_orders }}</p>
                </div>
                <div class="bg-prycegas-orange bg-opacity-10 p-4 rounded-lg">
                    <i class="fas fa-shopping-cart text-prycegas-orange text-2xl"></i>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-yellow-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Pending Orders</p>
                    <p class="text-3xl font-bold text-gray-900">{{ summary_stats.pending_count }}</p>
                </div>
                <div class="bg-yellow-100 p-4 rounded-lg">
                    <i class="fas fa-hourglass-half text-yellow-500 text-2xl"></i>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-prycegas-blue">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Out for Delivery</p>
                    <p class="text-3xl font-bold text-gray-900">{{ summary_stats.out_for_delivery_count }}</p>
                </div>
                <div class="bg-prycegas-blue bg-opacity-10 p-4 rounded-lg">
                    <i class="fas fa-truck text-prycegas-blue text-2xl"></i>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-prycegas-green">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-medium">Delivered Orders</p>
                    <p class="text-3xl font-bold text-gray-900">{{ summary_stats.delivered_count }}</p>
                </div>
                <div class="bg-prycegas-green bg-opacity-10 p-4 rounded-lg">
                    <i class="fas fa-check-circle text-prycegas-green text-2xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters & Search -->
    {% if summary_stats.total_orders > 0 %}
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <form method="get" class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <!-- Search -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Search</label>
                <input type="text" name="search" value="{{ search_query }}"
                    placeholder="Customer, product, or order ID..."
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-prycegas-orange">
            </div>

            <!-- Status Filter -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Status</label>
                <select name="status"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-prycegas-orange">
                    <option value="">All Statuses</option>
                    {% for code, name in status_choices %}
                    <option value="{{ code }}" {% if code == status_filter %} selected {% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Delivery Type Filter -->
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Delivery Type</label>
                <select name="delivery_type"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-prycegas-orange">
                    <option value="">All Types</option>
                    {% for code, name in delivery_choices %}
                    <option value="{{ code }}" {% if code == delivery_filter %} selected {% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Filter Button -->
            <div class="flex items-end gap-2">
                <button type="submit"
                    class="flex-1 bg-prycegas-orange hover:bg-prycegas-dark-orange text-white px-4 py-2 rounded-lg font-semibold transition-colors duration-200">
                    <i class="fas fa-search mr-2"></i>Filter
                </button>
                {% if search_query or status_filter or delivery_filter %}
                <a href="{% url 'core:cashier_order_list' %}"
                    class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-lg font-semibold transition-colors duration-200">
                    <i class="fas fa-times"></i>
                </a>
                {% endif %}
            </div>
        </form>
    </div>
    {% endif %}

    <!-- Orders Table -->
    {% if orders %}
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gradient-to-r from-prycegas-black to-prycegas-gray">
                    <tr>
                        <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Batch Order
                        </th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Customer
                        </th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Products
                        </th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Total
                            Amount</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Type</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Status
                        </th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Date</th>
                        <th class="px-6 py-4 text-left text-xs font-bold text-white uppercase tracking-wider">Actions
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for order in orders %}
                    <tr class="hover:bg-gray-50 transition-colors duration-200" id="order-row-{{ order.id }}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <p class="font-semibold text-gray-900">#{{ order.id }}</p>
                            {% if order.is_batch_order %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-700">
                                <i class="fas fa-layer-group mr-1"></i>{{ order.batch_item_count }} items
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if order.customer %}
                            <p class="text-gray-900">{{ order.customer.get_full_name|default:order.customer.username }}
                            </p>
                            <p class="text-xs text-gray-600">{{ order.customer.email }}</p>
                            {% else %}
                            <p class="text-gray-900 font-semibold">Walk-in Customer</p>
                            <p class="text-xs text-gray-600">
                                <i class="fas fa-walking mr-1"></i>No account
                            </p>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            {% if order.is_batch_order %}
                            <div class="space-y-1">
                                {% for item in order.batch_items %}
                                <div class="text-sm text-gray-900">{{ item.quantity }}x {{ item.product.name }} - {{ item.product.size }}</div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <p class="text-gray-900">{{ order.product.name }} - {{ order.product.size }}</p>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <p class="font-bold text-prycegas-orange">₱{{ order.batch_total|floatformat:2|intcomma }}
                            </p>
                            {% if order.is_batch_order %}
                            <p class="text-xs text-gray-500">({{ order.total_amount|floatformat:2 }} this item)</p>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold
                                {% if order.delivery_type == 'pickup' %}bg-blue-100 text-blue-700
                                {% else %}bg-purple-100 text-purple-700
                                {% endif %}">
                                {% if order.delivery_type == 'pickup' %}
                                <i class="fas fa-store mr-1"></i>Pickup
                                {% else %}
                                <i class="fas fa-truck mr-1"></i>Delivery
                                {% endif %}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold
                                {% if order.status == 'pending' %}bg-yellow-100 text-yellow-700
                                {% elif order.status == 'out_for_delivery' %}bg-blue-100 text-blue-700
                                {% elif order.status == 'delivered' %}bg-prycegas-green bg-opacity-10 text-prycegas-green
                                {% else %}bg-red-100 text-red-700
                                {% endif %}">
                                {{ order.get_status_display }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <p class="text-gray-500 text-sm">{{ order.order_date|date:"M d, Y" }}</p>
                            <p class="text-xs text-gray-400">{{ order.order_date|time:"g:i A" }}</p>
                        </td>
                        <!-- Actions Column -->
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex items-center space-x-2">
                                <!-- View Details Button -->
                                <button type="button"
                                    class="inline-flex items-center justify-center w-9 h-9 rounded-lg text-prycegas-orange hover:bg-orange-50 hover:text-prycegas-orange-dark transition-all duration-200"
                                    title="View Order Details" onclick="viewOrderDetail('{{ order.batch_id }}')">
                                    <i class="fas fa-eye"></i>
                                </button>

                                <!-- Status Update Dropdown -->
                                {% if order.status != 'delivered' and order.status != 'cancelled' %}
                                <div class="relative inline-block text-left" x-data="{ open: false }">
                                    <button type="button" @click="open = !open"
                                        class="inline-flex items-center justify-center w-9 h-9 rounded-lg text-gray-400 hover:bg-gray-100 hover:text-gray-600 transition-all duration-200"
                                        title="Update Status">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <div x-show="open" @click.away="open = false" x-transition
                                        class="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-xl z-10 border border-gray-200 py-1">
                                        {% if order.status == 'pending' %}
                                        <button type="button"
                                            onclick="updateBatchOrderStatus('{{ order.batch_id }}', 'out_for_delivery')"
                                            class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-orange-50 transition-colors">
                                            <i class="fas fa-truck mr-2 text-prycegas-orange"></i><span
                                                class="font-medium">Mark as Out for Delivery</span>
                                        </button>
                                        <button type="button" onclick="updateBatchOrderStatus('{{ order.batch_id }}', 'cancelled')"
                                            class="block w-full text-left px-4 py-2 text-sm text-red-700 hover:bg-red-50 transition-colors border-t border-gray-100">
                                            <i class="fas fa-ban mr-2"></i><span class="font-medium">Cancel Order</span>
                                        </button>
                                        {% elif order.status == 'out_for_delivery' %}
                                        <button type="button" onclick="updateBatchOrderStatus('{{ order.batch_id }}', 'delivered')"
                                            class="block w-full text-left px-4 py-2 text-sm text-green-700 hover:bg-green-50 transition-colors">
                                            <i class="fas fa-check-circle mr-2"></i><span class="font-medium">Mark as
                                                Delivered</span>
                                        </button>
                                        <button type="button" onclick="updateBatchOrderStatus('{{ order.batch_id }}', 'cancelled')"
                                            class="block w-full text-left px-4 py-2 text-sm text-red-700 hover:bg-red-50 transition-colors border-t border-gray-100">
                                            <i class="fas fa-ban mr-2"></i><span class="font-medium">Cancel Order</span>
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="mt-6 flex justify-center gap-2">
        {% if page_obj.has_previous %}
        <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}"
            class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">First</a>
        <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}"
            class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Previous</a>
        {% endif %}

        <span class="px-4 py-2 bg-prycegas-orange text-white rounded-lg">Page {{ page_obj.number }} of {{
            page_obj.paginator.num_pages }}</span>

        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}"
            class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Next</a>
        <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}"
            class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Last</a>
        {% endif %}
    </div>
    {% endif %}
    {% else %}
    <!-- Empty State -->
    <div class="bg-white rounded-xl shadow-lg p-12 text-center">
        <div class="flex justify-center mb-4">
            <div class="bg-gray-100 p-8 rounded-full">
                <i class="fas fa-inbox text-gray-400 text-4xl"></i>
            </div>
        </div>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">No Orders to Process</h3>
        <p class="text-gray-600 mb-6">There are no customer orders available at this time. Orders will appear here once
            customers place them.</p>
    </div>
    {% endif %}

    <!-- Order Detail Modal Container -->
    <div id="order-detail-modal"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function viewOrderDetail(batchId) {
        const url = '{% url "core:batch_order_detail_modal" "00000000-0000-0000-0000-000000000000" %}'.replace('00000000-0000-0000-0000-000000000000', batchId);

        fetch(url, {
            headers: {
                'HX-Request': 'true'
            }
        })
            .then(response => response.text())
            .then(html => {
                const container = document.getElementById('order-detail-modal');
                container.innerHTML = html;

                if (window.Alpine) {
                    setTimeout(() => {
                        const modalElement = container.querySelector('[x-data]');
                        if (modalElement && !modalElement._x_dataStack) {
                            Alpine.initTree(container);
                        }
                    }, 0);
                }
            })
            .catch(error => {
                console.error('Error loading order detail:', error);
                showToast('Error loading order details', 'error');
            });
    }

    function updateBatchOrderStatus(batchId, newStatus) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
            document.querySelector('meta[name=csrf-token]')?.getAttribute('content');

        if (!csrfToken) {
            showToast('Security token missing. Please refresh the page.', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('status', newStatus);

        if (newStatus === 'cancelled') {
            const reason = prompt("Please enter the reason for cancellation:");
            if (reason === null) return;
            if (reason.trim() === "") {
                showToast('Cancellation reason is required.', 'error');
                return;
            }
            formData.append('cancellation_reason', reason);
        }

        fetch('{% url "core:update_batch_order_status" "00000000-0000-0000-0000-000000000000" %}'.replace('00000000-0000-0000-0000-000000000000', batchId), {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(result => {
                if (result.success) {
                    const modal = document.getElementById('order-detail-modal');
                    if (modal) {
                        modal.innerHTML = '';
                    }

                    showToast(result.message || 'Batch order status updated successfully', 'success');

                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showToast(result.message || 'Failed to update batch order status', 'error');
                }
            })
            .catch(error => {
                console.error('Error updating batch order status:', error);
                showToast('Error updating batch order status: ' + error.message, 'error');
            });
    }

    function updateOrderStatus(orderId, newStatus) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
            document.querySelector('meta[name=csrf-token]')?.getAttribute('content');

        if (!csrfToken) {
            showToast('Security token missing. Please refresh the page.', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('status', newStatus);

        if (newStatus === 'cancelled') {
            const reason = prompt("Please enter the reason for cancellation:");
            if (reason === null) return;
            if (reason.trim() === "") {
                showToast('Cancellation reason is required.', 'error');
                return;
            }
            formData.append('cancellation_reason', reason);
        }

        fetch('{% url "core:update_order_status" 0 %}'.replace('0', orderId), {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(result => {
                if (result.success) {
                    const modal = document.getElementById('order-detail-modal');
                    if (modal) {
                        modal.innerHTML = '';
                    }

                    showToast(result.message || 'Order status updated successfully', 'success');

                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showToast(result.message || 'Failed to update order status', 'error');
                }
            })
            .catch(error => {
                console.error('Error updating order status:', error);
                showToast('Error updating order status: ' + error.message, 'error');
            });
    }

    // Function to show toast notifications
    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        const bgColor = {
            'success': 'bg-green-500',
            'error': 'bg-red-500',
            'info': 'bg-blue-500',
            'warning': 'bg-yellow-500'
        }[type] || 'bg-gray-500';

        toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 ${bgColor} shadow-lg transform transition-all duration-300 ease-in-out`;

        const icons = {
            'success': '✓',
            'error': '✗',
            'info': 'ℹ',
            'warning': '⚠'
        };

        const icon = icons[type] || '';
        toast.innerHTML = `<span class="mr-2">${icon}</span>${message}`;

        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 300);
        }, 3000);
    }
</script>
{% endblock %}
