{% extends 'base.html' %}

{% block title %}Order Management - Prycegas Station{% endblock %}

{% block content %}
<div class="order-management min-h-screen bg-gray-50" x-data="orderManagement()">
    <!-- Page Header -->
    <div class="bg-white shadow-sm border-b border-gray-200">
        <div class="px-6 lg:px-8 py-8">
            <div class="flex items-center justify-between">
                <div>
                    <div class="flex items-center mb-2">
                        <div class="w-10 h-10 bg-prycegas-orange rounded-xl flex items-center justify-center mr-3">
                            <i class="fas fa-clipboard-list text-white"></i>
                        </div>
                        <h1 class="text-3xl font-bold text-gray-900">Order Management</h1>
                    </div>
                    <p class="text-gray-600 ml-13">Manage customer orders and track delivery status</p>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Auto-refresh toggle -->
                    <div class="flex items-center bg-white rounded-xl px-4 py-2 shadow-sm border border-gray-200">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" x-model="autoRefresh" @change="toggleAutoRefresh()"
                                   class="sr-only">
                            <div class="relative">
                                <div class="block bg-gray-300 w-12 h-6 rounded-full"></div>
                                <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition shadow-sm"
                                     :class="{ 'transform translate-x-6 bg-prycegas-orange': autoRefresh }"></div>
                            </div>
                            <span class="ml-3 text-sm font-medium text-gray-700">Auto-refresh</span>
                        </label>
                    </div>
                    <!-- Manual refresh button -->
                    <button @click="refreshTable()"
                            :disabled="isLoading"
                            :class="isLoading ? 'opacity-50 cursor-not-allowed' : 'hover:from-prycegas-orange-dark hover:to-prycegas-orange hover:scale-105'"
                            class="inline-flex items-center px-6 py-3 border border-transparent text-sm font-semibold rounded-xl shadow-lg text-white bg-gradient-to-r from-prycegas-orange to-prycegas-orange-light focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-prycegas-orange transition-all duration-200">
                        <i :class="isLoading ? 'fas fa-spinner fa-spin' : 'fas fa-sync-alt'" class="mr-2"></i>
                        <span x-text="isLoading ? 'Refreshing...' : 'Refresh'"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Area -->
    <div class="px-6 lg:px-8 py-8">
        <!-- Summary Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-2xl shadow-xl border border-gray-100 p-6 hover:shadow-2xl transition-all duration-300">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg">
                            <i class="fas fa-shopping-cart text-white text-lg"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-semibold text-gray-600">Total Orders</p>
                        <p class="text-3xl font-bold text-gray-900">{{ summary_stats.total_orders }}</p>
                        <p class="text-xs text-blue-600 font-medium mt-1">
                            <i class="fas fa-chart-line mr-1"></i>All time
                        </p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-xl border border-gray-100 p-6 hover:shadow-2xl transition-all duration-300">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-xl flex items-center justify-center shadow-lg">
                            <i class="fas fa-clock text-white text-lg"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-semibold text-gray-600">Pending</p>
                        <p class="text-3xl font-bold text-gray-900">{{ summary_stats.pending_count }}</p>
                        <p class="text-xs text-yellow-600 font-medium mt-1">
                            <i class="fas fa-hourglass-half mr-1"></i>Awaiting processing
                        </p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-xl border border-gray-100 p-6 hover:shadow-2xl transition-all duration-300">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-gradient-to-r from-prycegas-orange to-prycegas-orange-light rounded-xl flex items-center justify-center shadow-lg">
                            <i class="fas fa-truck text-white text-lg"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-semibold text-gray-600">Out for Delivery</p>
                        <p class="text-3xl font-bold text-gray-900">{{ summary_stats.out_for_delivery_count }}</p>
                        <p class="text-xs text-prycegas-orange font-medium mt-1">
                            <i class="fas fa-route mr-1"></i>In transit
                        </p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-xl border border-gray-100 p-6 hover:shadow-2xl transition-all duration-300">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-green-600 rounded-xl flex items-center justify-center shadow-lg">
                            <i class="fas fa-check-circle text-white text-lg"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-semibold text-gray-600">Delivered</p>
                        <p class="text-3xl font-bold text-gray-900">{{ summary_stats.delivered_count }}</p>
                        <p class="text-xs text-green-600 font-medium mt-1">
                            <i class="fas fa-thumbs-up mr-1"></i>Completed
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters and Search -->
        <div class="bg-white rounded-2xl shadow-xl border border-gray-100 mb-8">
            <div class="px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white rounded-t-2xl">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-prycegas-orange rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-filter text-white text-sm"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900">Filters & Search</h3>
                </div>
            </div>
            <div class="p-6">
                <form method="GET" class="space-y-6" x-ref="filterForm">
                    {% csrf_token %}
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Status Filter -->
                        <div>
                            <label for="status" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-tasks mr-2 text-prycegas-orange"></i>Status
                            </label>
                            <select name="status" id="status"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-prycegas-orange focus:border-transparent transition-all duration-200"
                                    @change="applyFilters()">
                                <option value="">All Statuses</option>
                                {% for value, label in status_choices %}
                                    <option value="{{ value }}" {% if current_filters.status == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Delivery Type Filter -->
                        <div>
                            <label for="delivery_type" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-truck mr-2 text-prycegas-orange"></i>Delivery Type
                            </label>
                            <select name="delivery_type" id="delivery_type"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-prycegas-orange focus:border-transparent transition-all duration-200"
                                    @change="applyFilters()">
                                <option value="">All Types</option>
                                {% for value, label in delivery_choices %}
                                    <option value="{{ value }}" {% if current_filters.delivery_type == value %}selected{% endif %}>
                                        {{ label }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Date From -->
                        <div>
                            <label for="date_from" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-calendar-alt mr-2 text-prycegas-orange"></i>From Date
                            </label>
                            <input type="date" name="date_from" id="date_from"
                                   value="{{ current_filters.date_from }}"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-prycegas-orange focus:border-transparent transition-all duration-200"
                                   @change="applyFilters()">
                        </div>

                        <!-- Date To -->
                        <div>
                            <label for="date_to" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-calendar-alt mr-2 text-prycegas-orange"></i>To Date
                            </label>
                            <input type="date" name="date_to" id="date_to"
                                   value="{{ current_filters.date_to }}"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-prycegas-orange focus:border-transparent transition-all duration-200"
                                   @change="applyFilters()">
                        </div>
                    </div>

                    <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between space-y-4 lg:space-y-0 lg:space-x-6">
                        <!-- Search -->
                        <div class="flex-1 max-w-lg">
                            <label for="search" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-search mr-2 text-prycegas-orange"></i>Search
                            </label>
                            <div class="relative">
                                <input type="text" name="search" id="search"
                                       value="{{ current_filters.search }}"
                                       placeholder="Search by customer name or order ID..."
                                       class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-prycegas-orange focus:border-transparent transition-all duration-200"
                                       @input="debounceSearch($event)">
                                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                    <i class="fas fa-search text-gray-400"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Sort -->
                        <div class="min-w-0 flex-shrink-0">
                            <label for="sort" class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-sort mr-2 text-prycegas-orange"></i>Sort By
                            </label>
                            <select name="sort" id="sort"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-prycegas-orange focus:border-transparent transition-all duration-200"
                                    @change="applyFilters()">
                                <option value="-order_date" {% if current_filters.sort == '-order_date' %}selected{% endif %}>Newest First</option>
                                <option value="order_date" {% if current_filters.sort == 'order_date' %}selected{% endif %}>Oldest First</option>
                                <option value="-total_amount" {% if current_filters.sort == '-total_amount' %}selected{% endif %}>Highest Amount</option>
                                <option value="total_amount" {% if current_filters.sort == 'total_amount' %}selected{% endif %}>Lowest Amount</option>
                                <option value="customer__username" {% if current_filters.sort == 'customer__username' %}selected{% endif %}>Customer A-Z</option>
                                <option value="-customer__username" {% if current_filters.sort == '-customer__username' %}selected{% endif %}>Customer Z-A</option>
                                <option value="status" {% if current_filters.sort == 'status' %}selected{% endif %}>Status A-Z</option>
                                <option value="-status" {% if current_filters.sort == '-status' %}selected{% endif %}>Status Z-A</option>
                            </select>
                        </div>

                        <!-- Clear Filters -->
                        <div class="flex-shrink-0">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">&nbsp;</label>
                            <button type="button" @click="clearFilters()"
                                    class="inline-flex items-center px-6 py-3 border border-gray-300 text-sm font-semibold rounded-xl text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-prycegas-orange transition-all duration-200 hover:scale-105">
                                <i class="fas fa-times mr-2"></i>
                                Clear Filters
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Bulk Operations -->
        <div class="bg-white rounded-2xl shadow-xl border border-gray-100 mb-8" x-show="selectedOrders.length > 0" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform scale-95" x-transition:enter-end="opacity-100 transform scale-100" x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 transform scale-100" x-transition:leave-end="opacity-0 transform scale-95">
            <div class="px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-purple-50 to-white rounded-t-2xl">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center mr-3 animate-pulse">
                            <i class="fas fa-tasks text-white text-sm"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900">
                            Bulk Operations (<span x-text="selectedOrders.length" class="text-purple-600 font-bold"></span> selected)
                        </h3>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">
                            Press Ctrl+A to select all
                        </span>
                        <button @click="clearSelection()"
                                class="text-sm font-medium text-gray-500 hover:text-gray-700 transition-colors duration-200 hover:bg-gray-100 px-3 py-1 rounded-lg">
                            <i class="fas fa-times mr-1"></i>Clear Selection
                        </button>
                    </div>
                </div>
            </div>
            <div class="p-6">
                <div class="flex flex-wrap gap-4">
                    <button @click="bulkOperation('mark_out_for_delivery')"
                            :disabled="!canMarkOutForDelivery() || isProcessingBulk"
                            :class="(canMarkOutForDelivery() && !isProcessingBulk) ? 'bg-gradient-to-r from-prycegas-orange to-prycegas-orange-light hover:from-prycegas-orange-dark hover:to-prycegas-orange hover:scale-105' : 'bg-gray-300 cursor-not-allowed'"
                            class="inline-flex items-center px-6 py-3 border border-transparent text-sm font-semibold rounded-xl shadow-lg text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-prycegas-orange transition-all duration-200">
                        <i :class="isProcessingBulk ? 'fas fa-spinner fa-spin' : 'fas fa-truck'" class="mr-2"></i>
                        <span x-text="isProcessingBulk ? 'Processing...' : 'Mark as Out for Delivery'"></span>
                    </button>
                    <button @click="bulkOperation('mark_delivered')"
                            :disabled="!canMarkDelivered() || isProcessingBulk"
                            :class="(canMarkDelivered() && !isProcessingBulk) ? 'bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 hover:scale-105' : 'bg-gray-300 cursor-not-allowed'"
                            class="inline-flex items-center px-6 py-3 border border-transparent text-sm font-semibold rounded-xl shadow-lg text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-all duration-200">
                        <i :class="isProcessingBulk ? 'fas fa-spinner fa-spin' : 'fas fa-check-circle'" class="mr-2"></i>
                        <span x-text="isProcessingBulk ? 'Processing...' : 'Mark as Delivered'"></span>
                    </button>
                    <button @click="bulkOperation('cancel_orders')"
                            :disabled="!canCancelOrders() || isProcessingBulk"
                            :class="(canCancelOrders() && !isProcessingBulk) ? 'bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 hover:scale-105' : 'bg-gray-300 cursor-not-allowed'"
                            class="inline-flex items-center px-6 py-3 border border-transparent text-sm font-semibold rounded-xl shadow-lg text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all duration-200">
                        <i :class="isProcessingBulk ? 'fas fa-spinner fa-spin' : 'fas fa-ban'" class="mr-2"></i>
                        <span x-text="isProcessingBulk ? 'Processing...' : 'Cancel Orders'"></span>
                    </button>
                </div>
                <div class="mt-4 text-xs text-gray-500 space-y-1">
                    <p><i class="fas fa-info-circle mr-1"></i>Tip: Only orders with compatible statuses will be processed. Invalid orders will be skipped.</p>
                    <p><i class="fas fa-keyboard mr-1"></i>Shortcuts: <kbd class="px-1 py-0.5 bg-gray-200 rounded text-xs">Ctrl+A</kbd> Select All, <kbd class="px-1 py-0.5 bg-gray-200 rounded text-xs">Esc</kbd> Clear Selection, <kbd class="px-1 py-0.5 bg-gray-200 rounded text-xs">Ctrl+R</kbd> Refresh</p>
                </div>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="bg-white rounded-2xl shadow-xl border border-gray-100">
            <div class="px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white rounded-t-2xl">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-table text-white text-sm"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900">Orders</h3>
                </div>
            </div>
            <div id="order-table-container">
                {% include 'dealer/order_table_partial.html' %}
            </div>
        </div>

        <!-- Order Detail Modal -->
        <div id="order-detail-modal"></div>
    </div>
</div>

<style>
/* Custom toggle switch styling */
.dot {
    transition: transform 0.3s ease, background-color 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* Enhanced hover effects */
.hover\:scale-105:hover {
    transform: scale(1.05);
}

/* Smooth transitions for all interactive elements */
.transition-all {
    transition: all 0.2s ease-in-out;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Wait for Alpine.js to be ready
document.addEventListener('alpine:init', () => {
    console.log('Alpine.js initialized, setting up order management');
});

function orderManagement() {
    return {
        autoRefresh: false,
        refreshInterval: null,
        selectedOrders: [],
        searchTimeout: null,
        isLoading: false,
        isProcessingBulk: false,

        init() {
            // Initialize any needed setup
            console.log('Order management component initialized');

            // Make component methods globally accessible for table partials
            window.orderManagementComponent = this;

            // Small delay to ensure DOM is ready
            this.$nextTick(() => {
                this.setupHTMXListeners();
                this.setupKeyboardShortcuts();
                console.log('Order management setup complete');
            });
        },

        setupHTMXListeners() {
            // Listen for HTMX events to maintain state
            document.addEventListener('htmx:afterSwap', (event) => {
                if (event.detail.target.id === 'order-table-container') {
                    // Restore checkbox states after table content is swapped
                    this.restoreCheckboxStates();
                }
            });

            // Listen for successful bulk operations
            document.addEventListener('htmx:responseError', (event) => {
                if (event.detail.xhr.status >= 400) {
                    this.showToast('Operation failed. Please try again.', 'error');
                }
            });
        },

        setupKeyboardShortcuts() {
            document.addEventListener('keydown', (event) => {
                // Ctrl+A to select all orders
                if (event.ctrlKey && event.key === 'a' && !event.target.matches('input, textarea')) {
                    event.preventDefault();
                    this.selectAllOrders();
                    this.showToast('All orders selected', 'info');
                }

                // Escape to clear selection
                if (event.key === 'Escape' && this.selectedOrders.length > 0) {
                    this.clearSelection();
                    this.showToast('Selection cleared', 'info');
                }

                // Ctrl+R to refresh table
                if (event.ctrlKey && event.key === 'r') {
                    event.preventDefault();
                    this.refreshTable();
                    this.showToast('Table refreshed', 'info');
                }
            });
        },

        toggleAutoRefresh() {
            if (this.autoRefresh) {
                this.startAutoRefresh();
            } else {
                this.stopAutoRefresh();
            }
        },

        startAutoRefresh() {
            this.refreshInterval = setInterval(() => {
                this.refreshTable();
            }, 30000); // Refresh every 30 seconds
        },

        stopAutoRefresh() {
            if (this.refreshInterval) {
                clearInterval(this.refreshInterval);
                this.refreshInterval = null;
            }
        },

        refreshTable() {
            this.isLoading = true;
            const params = new URLSearchParams(new FormData(this.$refs.filterForm));
            htmx.ajax('GET', '{% url "core:refresh_order_table" %}?' + params.toString(), {
                target: '#order-table-container',
                swap: 'innerHTML'
            }).then(() => {
                // Restore checkbox states after table refresh
                this.restoreCheckboxStates();
                this.isLoading = false;
            }).catch(() => {
                this.isLoading = false;
                this.showToast('Failed to refresh table', 'error');
            });
        },

        applyFilters() {
            this.$refs.filterForm.submit();
        },

        debounceSearch(event) {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                this.applyFilters();
            }, 500);
        },

        clearFilters() {
            // Reset all form fields
            this.$refs.filterForm.reset();
            this.applyFilters();
        },

        toggleOrderSelection(orderId) {
            const index = this.selectedOrders.indexOf(orderId);
            if (index > -1) {
                this.selectedOrders.splice(index, 1);
            } else {
                this.selectedOrders.push(orderId);
            }
            // Update the select all checkbox state
            this.updateSelectAllCheckbox();
        },

        selectAllOrders() {
            const checkboxes = document.querySelectorAll('input[name="order_checkbox"]');
            this.selectedOrders = [];
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                this.selectedOrders.push(parseInt(checkbox.value));
            });
            this.updateSelectAllCheckbox();
        },

        clearSelection() {
            this.selectedOrders = [];
            const checkboxes = document.querySelectorAll('input[name="order_checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            this.updateSelectAllCheckbox();
        },

        restoreCheckboxStates() {
            // Restore checkbox states after table refresh
            const checkboxes = document.querySelectorAll('input[name="order_checkbox"]');
            checkboxes.forEach(checkbox => {
                const orderId = parseInt(checkbox.value);
                checkbox.checked = this.selectedOrders.includes(orderId);
            });

            // Update the select all checkbox state
            this.updateSelectAllCheckbox();
        },

        updateSelectAllCheckbox() {
            const selectAllCheckbox = document.querySelector('thead input[type="checkbox"]');
            const orderCheckboxes = document.querySelectorAll('input[name="order_checkbox"]');

            if (selectAllCheckbox && orderCheckboxes.length > 0) {
                const checkedCount = this.selectedOrders.length;
                const totalCount = orderCheckboxes.length;

                if (checkedCount === 0) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                } else if (checkedCount === totalCount) {
                    selectAllCheckbox.checked = true;
                    selectAllCheckbox.indeterminate = false;
                } else {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = true;
                }
            }
        },

        // Helper functions for table partials to access main component
        handleSelectAllChange(event) {
            if (event.target.checked) {
                this.selectAllOrders();
            } else {
                this.clearSelection();
            }
        },

        handleOrderCheckboxChange(orderId, event) {
            this.toggleOrderSelection(orderId);
        },

        isOrderSelected(orderId) {
            return this.selectedOrders.includes(orderId);
        },

        // Test function for debugging
        testBulkOperation() {
            console.log('Testing bulk operation...');
            console.log('Selected orders:', this.selectedOrders);
            console.log('CSRF token:', this.getCSRFToken());
            console.log('Component state:', {
                selectedOrders: this.selectedOrders,
                isProcessingBulk: this.isProcessingBulk
            });
        },

        // Helper methods for bulk operation validation
        canMarkOutForDelivery() {
            return this.selectedOrders.length > 0;
        },

        canMarkDelivered() {
            return this.selectedOrders.length > 0;
        },

        canCancelOrders() {
            return this.selectedOrders.length > 0;
        },

        bulkOperation(operation) {
            if (this.selectedOrders.length === 0) {
                this.showToast('No orders selected', 'error');
                return;
            }

            if (this.isProcessingBulk) {
                this.showToast('Another operation is in progress', 'warning');
                return;
            }

            // Show loading state
            this.isProcessingBulk = true;
            this.showToast('Processing bulk operation...', 'info');

            // Get CSRF token more reliably
            const csrfToken = this.getCSRFToken();
            if (!csrfToken) {
                this.showToast('Security token missing. Please refresh the page.', 'error');
                this.isProcessingBulk = false;
                return;
            }

            const formData = new FormData();
            formData.append('operation', operation);
            this.selectedOrders.forEach(orderId => {
                formData.append('order_ids', orderId);
            });

            // Use fetch instead of htmx.ajax for better error handling
            console.log('Sending bulk operation:', operation, 'for orders:', this.selectedOrders);
            console.log('CSRF token:', csrfToken);

            fetch('{% url "core:bulk_order_operations" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'HX-Request': 'true'
                }
            })
            .then(response => {
                console.log('Response received:', response.status, response.statusText);
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('Error response body:', text);
                        throw new Error(`HTTP ${response.status}: ${text}`);
                    });
                }
                return response.json();
            })
            .then(result => {
                console.log('Success response:', result);
                if (result.success) {
                    this.showToast(result.message, 'success');
                    this.clearSelection();
                    this.refreshTable();
                } else {
                    this.showToast(result.message || 'Operation failed', 'error');
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                this.showToast('Error performing bulk operation: ' + error.message, 'error');
            })
            .finally(() => {
                this.isProcessingBulk = false;
            });
        },

        getCSRFToken() {
            // Try multiple ways to get CSRF token
            let token = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
            if (!token) {
                token = document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
            }
            if (!token) {
                token = document.querySelector('input[name=csrfmiddlewaretoken]')?.value;
            }
            return token;
        },

        showOrderDetail(orderId) {
            console.log('Showing order detail for ID:', orderId);
            const url = '{% url "core:order_detail_modal" 0 %}'.replace('0', orderId);
            console.log('Request URL:', url);

            htmx.ajax('GET', url, {
                target: '#order-detail-modal',
                swap: 'innerHTML'
            }).then(() => {
                console.log('Order detail loaded successfully');
            }).catch((error) => {
                console.error('Error loading order detail:', error);
                this.showToast('Error loading order details', 'error');
            });
        },

        showToast(message, type = 'success') {
            // Create toast notification
            const toast = document.createElement('div');
            const bgColor = {
                'success': 'bg-green-500',
                'error': 'bg-red-500',
                'info': 'bg-blue-500',
                'warning': 'bg-yellow-500'
            }[type] || 'bg-gray-500';

            toast.className = `fixed top-4 right-4 px-6 py-3 rounded-md text-white z-50 ${bgColor} shadow-lg transform transition-all duration-300 ease-in-out`;
            toast.textContent = message;

            // Add icon based on type
            const icon = {
                'success': '✓',
                'error': '✗',
                'info': 'ℹ',
                'warning': '⚠'
            }[type] || '';

            if (icon) {
                toast.innerHTML = `<span class="mr-2">${icon}</span>${message}`;
            }

            document.body.appendChild(toast);

            // Auto-remove after delay (longer for info messages)
            const delay = type === 'info' ? 2000 : 3000;
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, delay);
        }
    }
}

// Enhanced HTMX response handling with better Alpine.js integration
document.addEventListener('htmx:responseError', function(event) {
    console.error('HTMX Response Error:', event.detail);
    // Use a more reliable way to get the Alpine component
    const orderMgmtElement = document.querySelector('.order-management[x-data]');
    if (orderMgmtElement && orderMgmtElement._x_dataStack) {
        const orderMgmt = orderMgmtElement._x_dataStack[0];
        if (orderMgmt && orderMgmt.showToast) {
            try {
                const response = JSON.parse(event.detail.xhr.response);
                orderMgmt.showToast(response.message || 'An error occurred', 'error');
            } catch (e) {
                orderMgmt.showToast('An error occurred', 'error');
            }
        }
    }
});

document.addEventListener('htmx:afterRequest', function(event) {
    console.log('HTMX After Request:', event.detail);
    const orderMgmtElement = document.querySelector('.order-management[x-data]');

    if (event.detail.xhr.status === 200 && orderMgmtElement && orderMgmtElement._x_dataStack) {
        const orderMgmt = orderMgmtElement._x_dataStack[0];
        try {
            const response = JSON.parse(event.detail.xhr.response);
            if (response.success && response.message && orderMgmt && orderMgmt.showToast) {
                orderMgmt.showToast(response.message, 'success');
            }
        } catch (e) {
            // Response is not JSON, likely HTML - this is normal for table refreshes
            console.log('Response is HTML, not JSON');
        }
    }
});

document.addEventListener('htmx:sendError', function(event) {
    console.error('HTMX Send Error:', event.detail);
    const orderMgmtElement = document.querySelector('.order-management[x-data]');
    if (orderMgmtElement && orderMgmtElement._x_dataStack) {
        const orderMgmt = orderMgmtElement._x_dataStack[0];
        if (orderMgmt && orderMgmt.showToast) {
            orderMgmt.showToast('Network error occurred', 'error');
        }
    }
});

// Handle successful table swaps with improved Alpine.js integration
document.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'order-table-container') {
        console.log('Table content swapped, restoring checkbox states');

        // Ensure global component reference is available
        const orderMgmtElement = document.querySelector('.order-management[x-data]');
        if (orderMgmtElement && orderMgmtElement._x_dataStack) {
            const orderMgmt = orderMgmtElement._x_dataStack[0];
            if (orderMgmt) {
                // Restore global reference
                window.orderManagementComponent = orderMgmt;

                // Restore checkbox states
                if (orderMgmt.restoreCheckboxStates) {
                    setTimeout(() => {
                        orderMgmt.restoreCheckboxStates();
                    }, 100);
                }
            }
        }
    }
});

// Debug helper to check if everything is working
window.debugOrderManagement = function() {
    console.log('=== Order Management Debug Info ===');
    console.log('Alpine.js available:', typeof Alpine !== 'undefined');
    console.log('HTMX available:', typeof htmx !== 'undefined');

    const orderMgmtElement = document.querySelector('.order-management[x-data]');
    console.log('Order management element found:', !!orderMgmtElement);

    if (orderMgmtElement) {
        console.log('Alpine data stack:', orderMgmtElement._x_dataStack);
        if (orderMgmtElement._x_dataStack && orderMgmtElement._x_dataStack[0]) {
            const data = orderMgmtElement._x_dataStack[0];
            console.log('Selected orders:', data.selectedOrders);
            console.log('Available methods:', Object.keys(data).filter(key => typeof data[key] === 'function'));
        }
    }

    console.log('Global component available:', !!window.orderManagementComponent);
    if (window.orderManagementComponent) {
        console.log('Global component selected orders:', window.orderManagementComponent.selectedOrders);
    }

    const checkboxes = document.querySelectorAll('input[name="order_checkbox"]');
    console.log('Order checkboxes found:', checkboxes.length);

    const selectAllCheckbox = document.querySelector('thead input[type="checkbox"]');
    console.log('Select all checkbox found:', !!selectAllCheckbox);

    const bulkButtons = document.querySelectorAll('button[x-on\\:click*="bulkOperation"]');
    console.log('Bulk operation buttons found:', bulkButtons.length);

    console.log('CSRF token available:', !!document.querySelector('[name=csrfmiddlewaretoken]'));
    console.log('================================');
};

// Auto-run debug on page load if in debug mode
if (window.location.search.includes('debug=true')) {
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(window.debugOrderManagement, 1000);
    });
}
</script>
{% endblock %}