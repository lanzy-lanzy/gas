{% extends 'base.html' %}

{% block title %}Edit Product - Prycegas Station{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b border-gray-200">
        <div class="px-6 lg:px-8">
            <div class="flex justify-between items-center py-8">
                <div>
                    <div class="flex items-center mb-2">
                        <div class="w-10 h-10 bg-prycegas-orange rounded-xl flex items-center justify-center mr-3">
                            <i class="fas fa-edit text-white"></i>
                        </div>
                        <h1 class="text-3xl font-bold text-gray-900">Edit Product</h1>
                    </div>
                    <p class="text-gray-600 ml-13">Update product information and settings</p>
                </div>
                <a href="{% url 'core:product_management' %}" 
                   class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-colors duration-200 flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Back to Products
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="px-6 lg:px-8 py-8">
        <div class="max-w-4xl mx-auto">
            <form method="POST" class="bg-white shadow-xl rounded-2xl border border-gray-100 overflow-hidden">
                {% csrf_token %}
                
                <div class="px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white">
                    <h2 class="text-xl font-bold text-gray-900">Product Information</h2>
                    <p class="text-sm text-gray-600 mt-1">Editing: {{ product.name }} - {{ product.size }}</p>
                </div>

                <div class="p-6 space-y-6">
                    <!-- Basic Information -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div>
                            <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Product Name *
                            </label>
                            {{ form.name }}
                            {% if form.name.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.name.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div>
                            <label for="{{ form.size.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Size *
                            </label>
                            {{ form.size }}
                            {% if form.size.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.size.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div>
                            <label for="{{ form.sku.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                SKU
                            </label>
                            {{ form.sku }}
                            {% if form.sku.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.sku.errors.0 }}</p>
                            {% endif %}
                            <p class="mt-1 text-xs text-gray-500">Leave blank to auto-generate</p>
                        </div>

                        <div>
                            <label for="{{ form.barcode.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Barcode
                            </label>
                            {{ form.barcode }}
                            {% if form.barcode.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.barcode.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div>
                            <label for="{{ form.category.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Category
                                <button type="button" 
                                        id="add-category-btn"
                                        class="ml-2 inline-flex items-center px-3 py-1 bg-prycegas-orange hover:bg-orange-600 text-white text-xs font-semibold rounded-lg transition-colors duration-200">
                                    <i class="fas fa-plus mr-1"></i>
                                    New
                                </button>
                            </label>
                            {{ form.category }}
                            {% if form.category.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.category.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div>
                            <label for="{{ form.weight.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Weight (kg)
                            </label>
                            {{ form.weight }}
                            {% if form.weight.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.weight.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Description -->
                    <div>
                        <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Description
                        </label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.description.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Pricing -->
                    <div class="border-t pt-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Pricing</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <label for="{{ form.price.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Selling Price (₱) *
                                </label>
                                {{ form.price }}
                                {% if form.price.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.price.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <div>
                                <label for="{{ form.cost_price.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Cost Price (₱) *
                                </label>
                                {{ form.cost_price }}
                                {% if form.cost_price.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.cost_price.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Inventory -->
                    <div class="border-t pt-6">
                        <h3 class="text-lg font-medium text-gray-900 mb-4">Inventory Settings</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <label for="{{ form.current_stock.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Current Stock *
                                </label>
                                {{ form.current_stock }}
                                {% if form.current_stock.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.current_stock.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <div>
                                <label for="{{ form.minimum_stock.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Minimum Stock *
                                </label>
                                {{ form.minimum_stock }}
                                {% if form.minimum_stock.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.minimum_stock.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <div>
                                <label for="{{ form.maximum_stock.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Maximum Stock *
                                </label>
                                {{ form.maximum_stock }}
                                {% if form.maximum_stock.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.maximum_stock.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <div>
                                <label for="{{ form.reorder_point.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Reorder Point *
                                </label>
                                {{ form.reorder_point }}
                                {% if form.reorder_point.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.reorder_point.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <div>
                                <label for="{{ form.reorder_quantity.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Reorder Quantity *
                                </label>
                                {{ form.reorder_quantity }}
                                {% if form.reorder_quantity.errors %}
                                    <p class="mt-1 text-sm text-red-600">{{ form.reorder_quantity.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Status -->
                    <div class="border-t pt-6">
                        <div class="flex items-center">
                            {{ form.is_active }}
                            <label for="{{ form.is_active.id_for_label }}" class="ml-2 block text-sm text-gray-900">
                                Product is active and available for orders
                            </label>
                        </div>
                        {% if form.is_active.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.is_active.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Form Errors -->
                    {% if form.non_field_errors %}
                        <div class="border-t pt-6">
                            <div class="bg-red-50 border border-red-200 rounded-xl p-4">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-exclamation-circle text-red-400"></i>
                                    </div>
                                    <div class="ml-3">
                                        <h3 class="text-sm font-medium text-red-800">Please correct the following errors:</h3>
                                        <div class="mt-2 text-sm text-red-700">
                                            {{ form.non_field_errors }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <!-- Form Actions -->
                <div class="px-6 py-4 bg-gray-50 border-t border-gray-100 flex justify-end space-x-3">
                    <a href="{% url 'core:product_management' %}" 
                       class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl font-semibold transition-colors duration-200">
                        Cancel
                    </a>
                    <button type="submit" 
                            class="bg-prycegas-orange hover:bg-orange-600 text-white px-6 py-3 rounded-xl font-semibold transition-colors duration-200">
                        <i class="fas fa-save mr-2"></i>
                        Update Product
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div id="addCategoryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4">
        <div class="px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white flex justify-between items-center">
            <h2 class="text-xl font-bold text-gray-900">Create New Category</h2>
            <button type="button" id="close-modal" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <form id="categoryForm" class="p-6 space-y-4">
            {% csrf_token %}
            <div>
                <label for="categoryName" class="block text-sm font-medium text-gray-700 mb-2">
                    Category Name *
                </label>
                <input type="text" 
                       id="categoryName" 
                       name="name"
                       class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-prycegas-orange focus:border-transparent"
                       placeholder="e.g., LPG Gas, Accessories"
                       required>
                <p id="categoryNameError" class="mt-1 text-sm text-red-600 hidden"></p>
            </div>
            
            <div>
                <label for="categoryDescription" class="block text-sm font-medium text-gray-700 mb-2">
                    Description (optional)
                </label>
                <textarea id="categoryDescription" 
                          name="description"
                          class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-prycegas-orange focus:border-transparent"
                          rows="3"
                          placeholder="Brief description of the category"></textarea>
                <p id="categoryDescError" class="mt-1 text-sm text-red-600 hidden"></p>
            </div>
            
            <p id="categorySuccess" class="text-sm text-green-600 hidden flex items-center">
                <i class="fas fa-check-circle mr-2"></i>
                <span id="successMessage"></span>
            </p>
            
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" 
                        id="cancelCategoryBtn"
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-xl font-semibold transition-colors duration-200">
                    Cancel
                </button>
                <button type="submit" 
                        id="submitCategoryBtn"
                        class="bg-prycegas-orange hover:bg-orange-600 text-white px-6 py-2 rounded-xl font-semibold transition-colors duration-200 flex items-center">
                    <i class="fas fa-save mr-2"></i>
                    Create Category
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('addCategoryModal');
    const addCategoryBtn = document.getElementById('add-category-btn');
    const closeModalBtn = document.getElementById('close-modal');
    const cancelBtn = document.getElementById('cancelCategoryBtn');
    const categoryForm = document.getElementById('categoryForm');
    const categorySelect = document.getElementById('id_category_select');
    
    // Open modal
    addCategoryBtn.addEventListener('click', function(e) {
        e.preventDefault();
        modal.classList.remove('hidden');
        document.getElementById('categoryName').focus();
    });
    
    // Close modal
    function closeModal() {
        modal.classList.add('hidden');
        categoryForm.reset();
        clearErrors();
    }
    
    closeModalBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    
    // Close modal on outside click
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal();
        }
    });
    
    // Clear error messages
    function clearErrors() {
        document.getElementById('categoryNameError').classList.add('hidden');
        document.getElementById('categoryDescError').classList.add('hidden');
        document.getElementById('categorySuccess').classList.add('hidden');
    }
    
    // Submit form
    categoryForm.addEventListener('submit', function(e) {
        e.preventDefault();
        clearErrors();
        
        const name = document.getElementById('categoryName').value.trim();
        const description = document.getElementById('categoryDescription').value.trim();
        
        if (!name) {
            document.getElementById('categoryNameError').textContent = 'Category name is required.';
            document.getElementById('categoryNameError').classList.remove('hidden');
            return;
        }
        
        const submitBtn = document.getElementById('submitCategoryBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating...';
        
        fetch('{% url "core:create_category" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                name: name,
                description: description
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                document.getElementById('successMessage').textContent = data.message;
                document.getElementById('categorySuccess').classList.remove('hidden');
                
                // Add new option to select
                const option = document.createElement('option');
                option.value = data.category.id;
                option.textContent = data.category.name;
                categorySelect.appendChild(option);
                
                // Select the new category
                categorySelect.value = data.category.id;
                
                // Reset form and close after a short delay
                setTimeout(() => {
                    closeModal();
                }, 1500);
            } else {
                if (data.error.includes('already exists')) {
                    document.getElementById('categoryNameError').textContent = data.error;
                    document.getElementById('categoryNameError').classList.remove('hidden');
                } else {
                    document.getElementById('categoryNameError').textContent = data.error;
                    document.getElementById('categoryNameError').classList.remove('hidden');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('categoryNameError').textContent = 'Error creating category. Please try again.';
            document.getElementById('categoryNameError').classList.remove('hidden');
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Create Category';
        });
    });
});
</script>

<style>
#addCategoryModal.hidden {
    display: none;
}

#addCategoryModal:not(.hidden) {
    display: flex;
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}
</style>

{% endblock %}
