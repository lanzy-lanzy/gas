<!-- Delivery Logging Modal Content -->
{% load static %}
<div class="relative">
    <!-- Modal Header -->
    <div class="flex items-center justify-between pb-4 border-b border-gray-200">
        <div class="flex items-center">
            <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center mr-3">
                <i class="fas fa-truck-loading text-white"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-900">Log New Delivery</h3>
        </div>
        <button id="delivery-close-btn" 
                onclick="deliveryLogManager().closeDeliveryModal()"
                type="button"
                class="text-gray-400 hover:text-gray-600 focus:outline-none">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>

    <!-- Form Content -->
    <div class="py-6">
        <form id="delivery-form" hx-post="{% url 'core:log_delivery' %}"
              hx-target="#delivery-modal-content"
              hx-swap="innerHTML"
              hx-indicator="#loading-indicator">
            {% csrf_token %}
            
            <div class="space-y-6">
                <!-- Product Selection -->
                <div>
                    <label for="{{ form.product.id_for_label }}" class="block text-sm font-medium text-gray-700">
                        Product
                    </label>
                    <select name="{{ form.product.name }}" 
                            id="{{ form.product.id_for_label }}"
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-prycegas-orange focus:border-prycegas-orange"
                            required>
                        <option value="">Select a product</option>
                        {% for product in products %}
                        <option value="{{ product.id }}" 
                                data-price="{{ product.price }}" 
                                data-cost="{{ product.cost_price }}"
                                data-stock="{{ product.current_stock }}">
                            {{ product.name }} - {{ product.size }} (Stock: {{ product.current_stock }} units)
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Product Price Info Display -->
                <div id="price-info-display" class="hidden bg-gradient-to-r from-gray-50 to-white rounded-xl p-4 border border-gray-200">
                    <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-tags mr-2 text-prycegas-orange"></i>
                        Price Breakdown
                    </h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-center p-3 bg-red-50 rounded-lg border border-red-100">
                            <p class="text-xs text-red-600 font-medium mb-1">Buy Price/Unit</p>
                            <p id="display-buy-price" class="text-lg font-bold text-red-600">₱0.00</p>
                        </div>
                        <div class="text-center p-3 bg-blue-50 rounded-lg border border-blue-100">
                            <p class="text-xs text-blue-600 font-medium mb-1">Sell Price/Unit</p>
                            <p id="display-sell-price" class="text-lg font-bold text-blue-600">₱0.00</p>
                        </div>
                        <div class="text-center p-3 bg-emerald-50 rounded-lg border border-emerald-100">
                            <p class="text-xs text-emerald-600 font-medium mb-1">Profit/Unit</p>
                            <p id="display-profit-unit" class="text-lg font-bold text-emerald-600">₱0.00</p>
                        </div>
                    </div>
                </div>

                <!-- Quantity and Supplier Row -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="{{ form.quantity_received.id_for_label }}" class="block text-sm font-medium text-gray-700">
                            Quantity Received
                        </label>
                        <input type="number" 
                               name="{{ form.quantity_received.name }}" 
                               id="{{ form.quantity_received.id_for_label }}"
                               min="1"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-prycegas-orange focus:border-prycegas-orange auto-calculate"
                               placeholder="Enter quantity received"
                               required>
                    </div>

                    <div>
                        <label for="{{ form.supplier_name.id_for_label }}" class="block text-sm font-medium text-gray-700">
                            Supplier/Distributor
                        </label>
                        <input type="text"
                               name="{{ form.supplier_name.name }}"
                               id="{{ form.supplier_name.id_for_label }}"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-prycegas-orange focus:border-prycegas-orange"
                               placeholder="Enter supplier/distributor name"
                               required>
                    </div>
                </div>

                <!-- Delivery Date -->
                <div>
                    <label for="{{ form.delivery_date.id_for_label }}" class="block text-sm font-medium text-gray-700">
                        Delivery Date & Time
                    </label>
                    <input type="datetime-local" 
                           name="{{ form.delivery_date.name }}" 
                           id="{{ form.delivery_date.id_for_label }}"
                           value="{{ form.delivery_date.initial }}"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-prycegas-orange focus:border-prycegas-orange"
                           required>
                </div>

                <!-- Cost Information Row -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="{{ form.cost_per_unit.id_for_label }}" class="block text-sm font-medium text-gray-700">
                            <i class="fas fa-shopping-cart text-red-500 mr-1"></i>
                            Cost per Unit (Buying Price) ₱
                        </label>
                        <input type="number" 
                               name="{{ form.cost_per_unit.name }}" 
                               id="{{ form.cost_per_unit.id_for_label }}"
                               step="0.01"
                               min="0"
                               class="mt-1 block w-full px-3 py-2 border border-red-200 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-red-500 focus:border-red-500 auto-calculate"
                               placeholder="Enter cost per unit"
                               required>
                    </div>

                    <div>
                        <label for="{{ form.total_cost.id_for_label }}" class="block text-sm font-medium text-gray-700">
                            <i class="fas fa-coins text-red-500 mr-1"></i>
                            Total Cost (Investment) ₱
                        </label>
                        <input type="number" 
                               name="{{ form.total_cost.name }}" 
                               id="{{ form.total_cost.id_for_label }}"
                               step="0.01"
                               readonly
                               class="mt-1 block w-full px-3 py-2 border border-red-200 rounded-md shadow-sm bg-red-50 placeholder-gray-400 focus:outline-none focus:ring-red-500 focus:border-red-500"
                               placeholder="Auto-calculated"
                               value="0.00">
                    </div>
                </div>

                <!-- Financial Summary Preview -->
                <div id="financial-summary" class="hidden bg-gradient-to-r from-emerald-50 to-blue-50 rounded-xl p-4 border border-emerald-200">
                    <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-chart-line mr-2 text-emerald-500"></i>
                        Financial Summary Preview
                    </h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-center p-3 bg-white rounded-lg border border-red-200">
                            <p class="text-xs text-red-600 font-medium mb-1">Total Investment</p>
                            <p id="summary-investment" class="text-lg font-bold text-red-600">₱0.00</p>
                        </div>
                        <div class="text-center p-3 bg-white rounded-lg border border-blue-200">
                            <p class="text-xs text-blue-600 font-medium mb-1">Potential Revenue</p>
                            <p id="summary-revenue" class="text-lg font-bold text-blue-600">₱0.00</p>
                        </div>
                        <div class="text-center p-3 bg-white rounded-lg border border-emerald-200">
                            <p class="text-xs text-emerald-600 font-medium mb-1">Potential Profit</p>
                            <p id="summary-profit" class="text-lg font-bold text-emerald-600">₱0.00</p>
                        </div>
                    </div>
                    <div class="mt-3 flex items-center justify-center">
                        <span id="profit-margin-badge" class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-emerald-100 text-emerald-800">
                            <i class="fas fa-percentage mr-1"></i>
                            <span id="summary-margin">0%</span> Profit Margin
                        </span>
                    </div>
                </div>

                <!-- Notes -->
                <div>
                    <label for="{{ form.notes.id_for_label }}" class="block text-sm font-medium text-gray-700">
                        Notes (Optional)
                    </label>
                    <textarea name="{{ form.notes.name }}" 
                              id="{{ form.notes.id_for_label }}"
                              rows="3"
                              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-prycegas-orange focus:border-prycegas-orange"
                              placeholder="Any additional notes about the delivery (optional)"></textarea>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex items-center justify-end space-x-3 pt-6 border-t border-gray-200 mt-6">
                <button type="button" id="delivery-cancel-btn"
                        class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-prycegas-orange disabled:opacity-50 disabled:cursor-not-allowed">
                    Cancel
                </button>
                <button type="submit" id="delivery-submit-btn"
                        disabled
                        class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-300 cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-prycegas-orange">
                    <span id="delivery-submit-text">Log Delivery</span>
                    <span id="loading-indicator" class="hidden flex items-center">
                        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Processing...
                    </span>
                </button>
            </div>
        </form>
    </div>
</div>
<script>
(function() {
    function initializeCalculations() {
        const form = document.getElementById('delivery-form');
        if (!form) return;
        
        const productSelect = form.querySelector('[name="product"]');
        const quantityInput = form.querySelector('[name="quantity_received"]');
        const costInput = form.querySelector('[name="cost_per_unit"]');
        const totalInput = form.querySelector('[name="total_cost"]');
        const submitBtn = document.getElementById('delivery-submit-btn');
        
        const priceInfoDisplay = document.getElementById('price-info-display');
        const financialSummary = document.getElementById('financial-summary');
        
        let sellPrice = 0;
        
        function formatCurrency(value) {
            return '₱' + parseFloat(value || 0).toLocaleString('en-PH', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }
        
        function calculateAll() {
            const quantity = parseFloat(quantityInput.value) || 0;
            const buyPrice = parseFloat(costInput.value) || 0;
            const totalCost = quantity * buyPrice;
            const potentialRevenue = quantity * sellPrice;
            const potentialProfit = potentialRevenue - totalCost;
            const profitMargin = potentialRevenue > 0 ? (potentialProfit / potentialRevenue * 100) : 0;
            
            if (totalInput) {
                totalInput.value = totalCost.toFixed(2);
            }
            
            if (priceInfoDisplay) {
                document.getElementById('display-buy-price').textContent = formatCurrency(buyPrice);
                document.getElementById('display-sell-price').textContent = formatCurrency(sellPrice);
                document.getElementById('display-profit-unit').textContent = formatCurrency(sellPrice - buyPrice);
            }
            
            if (financialSummary) {
                document.getElementById('summary-investment').textContent = formatCurrency(totalCost);
                document.getElementById('summary-revenue').textContent = formatCurrency(potentialRevenue);
                document.getElementById('summary-profit').textContent = formatCurrency(potentialProfit);
                document.getElementById('summary-margin').textContent = profitMargin.toFixed(1);
                
                const marginBadge = document.getElementById('profit-margin-badge');
                if (profitMargin >= 20) {
                    marginBadge.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-emerald-100 text-emerald-800';
                } else if (profitMargin >= 10) {
                    marginBadge.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800';
                } else if (profitMargin > 0) {
                    marginBadge.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-orange-100 text-orange-800';
                } else {
                    marginBadge.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800';
                }
            }
            
            if (submitBtn) {
                const hasProduct = productSelect.value;
                const isValid = hasProduct && quantity > 0 && buyPrice > 0;
                submitBtn.disabled = !isValid;
                
                if (isValid) {
                    submitBtn.classList.remove('bg-gray-300', 'cursor-not-allowed');
                    submitBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                } else {
                    submitBtn.classList.add('bg-gray-300', 'cursor-not-allowed');
                    submitBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                }
            }
        }
        
        function handleProductChange() {
            const selectedOption = productSelect.options[productSelect.selectedIndex];
            sellPrice = parseFloat(selectedOption.dataset.price) || 0;
            
            if (productSelect.value) {
                priceInfoDisplay.classList.remove('hidden');
                financialSummary.classList.remove('hidden');
            } else {
                priceInfoDisplay.classList.add('hidden');
                financialSummary.classList.add('hidden');
            }
            
            calculateAll();
        }
        
        if (productSelect) {
            productSelect.addEventListener('change', handleProductChange);
        }
        
        if (quantityInput) {
            quantityInput.addEventListener('input', calculateAll);
        }
        
        if (costInput) {
            costInput.addEventListener('input', calculateAll);
        }
        
        calculateAll();
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeCalculations);
    } else {
        initializeCalculations();
    }
    
    document.addEventListener('htmx:afterSettle', initializeCalculations);
})();
</script>